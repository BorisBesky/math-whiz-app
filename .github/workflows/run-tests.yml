name: Run Tests

on:
  push: {}
  pull_request: {}

jobs:
  test:
    name: Run unit & integration tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Set up Java (required by Firestore emulator)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Restore Firebase Emulators cache
        id: firebase-emulators-cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/firebase/emulators
          key: firebase-emulators-${{ runner.os }}

      - name: Download Firebase Emulators
        if: steps.firebase-emulators-cache.outputs.cache-hit != 'true'
        run: npx firebase setup:emulators:firestore

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Debug snapshot (runner debug)
        if: ${{ runner.debug == '1' }}
        run: |
          echo "Runner debug is enabled"
          echo "Node: $(node -v)"
          echo "npm: $(npm -v)"
          echo "firebase-tools: $(npx firebase --version)"
          echo "playwright: $(npx playwright --version)"
          echo "PWD: $PWD"
          echo "Branch: $GITHUB_REF"

      - name: Start Firebase Emulators
        run: npx firebase emulators:start --only auth,firestore --project demo-mathwhiz > emulator.log 2>&1 &

      - name: Wait for emulators to be ready
        run: npx wait-on tcp:127.0.0.1:9099 tcp:127.0.0.1:8080 --timeout 60000

      - name: Verify emulator ports (runner debug)
        if: ${{ runner.debug == '1' }}
        run: |
          echo "Checking listeners for emulator ports..."
          (ss -ltnp || true) | grep -E ':8080|:9099' || true
          echo "Last emulator log lines:"
          tail -n 80 emulator.log || true

      - name: Run Playwright tests
        run: |
          mkdir -p test-results
          if [ "${{ runner.debug }}" = "1" ]; then
            export DEBUG=pw:webserver
            echo "Playwright debug logging enabled: $DEBUG"
            echo "REACT_APP_FIREBASE_API_KEY set: ${REACT_APP_FIREBASE_API_KEY:+yes}"
            echo "REACT_APP_FIREBASE_PROJECT_ID: ${REACT_APP_FIREBASE_PROJECT_ID}"
          fi
          npx playwright test --project=chromium --workers=2 --retries=1 --reporter=list,json
        timeout-minutes: 30
        env:
          REACT_APP_USE_EMULATOR: 'true'
          REACT_APP_FIREBASE_API_KEY: 'demo-api-key'
          REACT_APP_FIREBASE_AUTH_DOMAIN: 'demo-mathwhiz.firebaseapp.com'
          REACT_APP_FIREBASE_PROJECT_ID: 'demo-mathwhiz'
          REACT_APP_FIREBASE_STORAGE_BUCKET: 'demo-mathwhiz.appspot.com'
          REACT_APP_FIREBASE_MESSAGING_SENDER_ID: '1234567890'
          REACT_APP_FIREBASE_APP_ID: '1:1234567890:web:abcdef1234567890'
          PLAYWRIGHT_JSON_OUTPUT_NAME: test-results/playwright-results.json

      - name: Dump debug artifacts on failure
        if: failure()
        run: |
          echo "===== emulator.log (tail) ====="
          tail -n 200 emulator.log || true
          echo "===== Playwright error contexts ====="
          find test-results -name 'error-context.md' -maxdepth 4 -print -exec sh -c 'echo "----- $1 -----"; sed -n "1,200p" "$1"' _ {} \; || true

      - name: Print Playwright test timings (sorted)
        if: always()
        run: |
          node <<'NODE'
          const fs = require('fs');
          const path = 'test-results/playwright-results.json';

          if (!fs.existsSync(path)) {
            console.log('No Playwright JSON results found.');
            process.exit(0);
          }

          const data = JSON.parse(fs.readFileSync(path, 'utf8'));
          const rows = [];

          const walk = (suite, prefix = '') => {
            for (const spec of (suite.specs || [])) {
              const title = [prefix, spec.title].filter(Boolean).join(' › ');
              for (const test of (spec.tests || [])) {
                const project = test.projectName || 'unknown';
                const duration = (test.results || []).reduce((max, result) => Math.max(max, result.duration || 0), 0);
                rows.push({ title: '[' + project + '] ' + title, duration });
              }
            }

            for (const child of (suite.suites || [])) {
              const childPrefix = [prefix, child.title].filter(Boolean).join(' › ');
              walk(child, childPrefix);
            }
          };

          for (const root of (data.suites || [])) {
            walk(root, root.title || '');
          }

          rows.sort((a, b) => b.duration - a.duration);
          console.log('Playwright test durations (slowest first):');
          for (const row of rows) {
            const padded = String(row.duration).padStart(6);
            console.log(padded + ' ms  ' + row.title);
          }
          NODE

      - name: Save Firebase Emulators cache
        if: always() && steps.firebase-emulators-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/firebase/emulators
          key: firebase-emulators-${{ runner.os }}
