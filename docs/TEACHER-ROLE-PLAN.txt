Step 1: Custom Claim
Create Cloud Function to set the custom claim on the teacher's Auth account. This identifies them as a "teacher" in the system

JavaScript

// This claim simply confirms: "This user IS a teacher."
await admin.auth().setCustomUserClaims(userUid, { role: "teacher" });



How This Rule Works:
When teacher with UID UID_T tries to read student with UID UID_S:

Firebase checks: request.auth.token.role == 'teacher'. This is true.
Firebase looks at the student document's data (resource.data) and finds its classId is UID_C.
The get() function fetches the document at /classStudents/UID_C.
It reads the data from that class: .data.teacherId, which is UID_T.
It compares that value to the requesting user's ID: UID_T == UID_T. This is true.
Since both conditions are true, access is GRANTED.
If with UID_Alice tried to read the same record, it would fail (UID_Alice == UID_T), and access would be DENIED.